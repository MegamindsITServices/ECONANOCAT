name: Deploy Econanocat to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Website
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v3

      - name: ðŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v0.1.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script_stop: true
          script: |
            set -e
            echo "âœ… Connected to Econanocat VPS"
            
            # Load Node environment
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            # 1. Navigate to project and pull changes
            cd /root/econanocat
            echo "ðŸ“¥ Pulling latest changes..."
            git pull origin main

            # 2. Build Frontend
            echo "ðŸ§± Building frontend..."
            cd frontend # <--- Navigate into frontend folder
            npm install
            npm run build
            
            echo "ðŸ“¤ Refreshing /var/www/econanocat..."
            sudo mkdir -p /var/www/econanocat/dist
            sudo rm -rf /var/www/econanocat/dist/*
            sudo cp -R dist/* /var/www/econanocat/dist/
            
            sudo chown -R www-data:www-data /var/www/econanocat/
            sudo chmod -R 755 /var/www/econanocat/

            # 3. Setup Backend
            echo "ðŸ§© Setting up backend..."
            cd ../backend # <--- Move from frontend to backend folder
            npm install
            
            # 4. Restart PM2
            echo "ðŸ” Restarting PM2 on port 5005..."
            # Using index.js as per your git logs
            if pm2 list | grep -q "econanocat"; then
              pm2 restart econanocat
            else
              PORT=5005 pm2 start index.js --name econanocat
            fi

            pm2 save
            echo "ðŸŽ‰ Deployment for ECONANOCAT completed!"