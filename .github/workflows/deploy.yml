name: Deploy Econanocat to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Website
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v3

      - name: ğŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v0.1.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script_stop: true
          script: |
            set -e
            echo "âœ… Connected to Econanocat VPS"
            
            # Use 'which' to dynamically find node/npm path or use standard local path
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            # Navigate to project (Now the .git folder is here)
            cd /root/econanocat
            
            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin main

            # Build Frontend
            echo "ğŸ§± Building frontend..."
            npm install
            npm run build
            
            echo "ğŸ“¤ Refreshing /var/www/econanocat..."
            sudo mkdir -p /var/www/econanocat/dist
            sudo rm -rf /var/www/econanocat/dist/*
            sudo cp -R dist/* /var/www/econanocat/dist/
            
            sudo chown -R www-data:www-data /var/www/econanocat/
            sudo chmod -R 755 /var/www/econanocat/

            # Setup backend
            echo "ğŸ§© Setting up backend..."
            cd backend 
            npm install
            
            # Restart PM2
            echo "ğŸ” Restarting PM2 on port 5005..."
            if pm2 list | grep -q "econanocat"; then
              pm2 restart econanocat
            else
              # Passing the port as an environment variable is cleaner
              PORT=5005 pm2 start server.js --name econanocat
            fi

            pm2 save
            echo "ğŸ‰ Deployment for ECONANOCAT completed!"